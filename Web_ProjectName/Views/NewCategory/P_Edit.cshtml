@{
    ViewData["Title"] = "Chỉnh sửa danh mục tin tức";
    ViewData["Description"] = "Chỉnh sửa thông tin danh mục tin tức";
    Layout = "_LayoutDashmin";
}

<!-- Content Start -->
<div class="container-fluid pt-4 px-4">
    <div class="row g-4">
        <div class="col-12">
            <div class="bg-light rounded h-100 p-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h6 class="mb-0">Chỉnh sửa danh mục tin tức</h6>
                    <a href="/new-category" class="btn btn-outline-secondary">
                        <i class="fa fa-arrow-left me-2"></i>Quay lại
                    </a>
                </div>

                <div class="row">
                    <div class="col-md-8">
                        <form id="editCategoryForm">
                            <input type="hidden" id="categoryId" name="id">

                            <div class="mb-3">
                                <label for="categoryName" class="form-label">Tên danh mục *</label>
                                <input type="text" class="form-control" id="categoryName" name="name" required>
                                <div class="form-text">Tên danh mục không được để trống</div>
                            </div>

                            <div class="mb-3">
                                <label for="categoryStatus" class="form-label">Trạng thái</label>
                                <select class="form-select" id="categoryStatus" name="status">
                                    <option value="1">Hoạt động</option>
                                    <option value="0">Không hoạt động</option>
                                </select>
                            </div>

                            <div class="mb-3">
                                <label for="categoryMetaUrl" class="form-label">URL Meta</label>
                                <input type="text" class="form-control" id="categoryMetaUrl" name="metaUrl"
                                    placeholder="url-meta-danh-muc">
                                <div class="form-text">URL thân thiện cho SEO (tùy chọn)</div>
                            </div>

                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fa fa-save me-2"></i>Cập nhật danh mục
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="resetForm()">
                                    <i class="fa fa-refresh me-2"></i>Làm mới
                                </button>
                            </div>
                        </form>
                    </div>

                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">Thông tin danh mục</h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <strong>ID:</strong>
                                    <span id="categoryIdDisplay">-</span>
                                </div>
                                <div class="mb-3">
                                    <strong>Ngày tạo:</strong>
                                    <span id="categoryCreatedAt">-</span>
                                </div>
                                <div class="mb-3">
                                    <strong>Cập nhật lần cuối:</strong>
                                    <span id="categoryUpdatedAt">-</span>
                                </div>
                                <hr>
                                <div class="alert alert-info">
                                    <i class="fa fa-info-circle me-2"></i>
                                    <small>Thay đổi sẽ được áp dụng ngay lập tức</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Content End -->

@section Scripts {
    <script>
        let categoryId = null;

        $(document).ready(function () {
            // Get category ID from URL
            const urlParams = new URLSearchParams(window.location.search);
            categoryId = urlParams.get('id');

            if (!categoryId) {
                showAlert('Không tìm thấy ID danh mục', 'error');
                setTimeout(() => {
                    window.location.href = '/new-category';
                }, 2000);
                return;
            }

            // Load category data
            loadCategoryData();

            // Auto generate meta URL from name
            $('#categoryName').on('input', function () {
                const name = $(this).val();
                if (name && !$('#categoryMetaUrl').val()) {
                    const metaUrl = generateMetaUrl(name);
                    $('#categoryMetaUrl').val(metaUrl);
                }
            });

            // Form submission
            $('#editCategoryForm').on('submit', function (e) {
                e.preventDefault();
                updateCategory();
            });
        });

        function loadCategoryData() {
            $.ajax({
                url: `/NewCategory/GetById?id=${categoryId}`,
                type: 'GET',
                success: function (response) {
                    if (response.result === 1) {
                        const category = response.data;
                        populateForm(category);
                    } else {
                        showAlert('Không tìm thấy danh mục', 'error');
                        setTimeout(() => {
                            window.location.href = '/new-category';
                        }, 2000);
                    }
                },
                error: function () {
                    showAlert('Lỗi kết nối', 'error');
                }
            });
        }

        function populateForm(category) {
            $('#categoryId').val(category.id);
            $('#categoryName').val(category.name);
            $('#categoryStatus').val(category.status);
            $('#categoryMetaUrl').val(category.metaUrl || '');

            // Display info
            $('#categoryIdDisplay').text(category.id);
            $('#categoryCreatedAt').text(new Date(category.createdAt).toLocaleDateString('vi-VN'));
            $('#categoryUpdatedAt').text(new Date(category.updatedAt).toLocaleDateString('vi-VN'));
        }

        function generateMetaUrl(name) {
            return name
                .toLowerCase()
                .replace(/[^a-z0-9\s-]/g, '')
                .replace(/\s+/g, '-')
                .replace(/-+/g, '-')
                .trim('-');
        }

        function updateCategory() {
            const formData = {
                id: parseInt($('#categoryId').val()),
                name: $('#categoryName').val(),
                status: parseInt($('#categoryStatus').val()),
                metaUrl: $('#categoryMetaUrl').val()
            };

            // Validation
            if (!formData.name.trim()) {
                showAlert('Vui lòng nhập tên danh mục', 'error');
                return;
            }

            $.ajax({
                url: '/new-category/update',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(formData),
                success: function (response) {
                    if (response.result === 1) {
                        showAlert('Cập nhật danh mục thành công!', 'success');
                        setTimeout(() => {
                            window.location.href = '/new-category';
                        }, 1500);
                    } else {
                        showAlert(response.error || 'Lỗi khi cập nhật danh mục', 'error');
                    }
                },
                error: function () {
                    showAlert('Lỗi kết nối', 'error');
                }
            });
        }

        function resetForm() {
            if (categoryId) {
                loadCategoryData();
            }
        }

        function showAlert(message, type) {
            const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
            const alertHtml = `
                                                <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                                                    ${message}
                                                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                                </div>
                                            `;

            // Remove existing alerts
            $('.alert').remove();

            // Add new alert
            $('.container-fluid').prepend(alertHtml);

            // Auto hide after 3 seconds
            setTimeout(() => {
                $('.alert').fadeOut();
            }, 3000);
        }
    </script>
}